# Outlook配置流程图 📊

## 整体流程概览

```
开始配置
    ↓
┌────────────────────────────────────────┐
│  第1步: Azure应用注册                    │
│  ✓ 获取Client ID                       │
│  ✓ 获取Tenant ID                       │
│  ✓ 获取Client Secret                   │
│  ✓ 配置API权限                         │
└────────────────────────────────────────┘
    ↓
┌────────────────────────────────────────┐
│  第2步: SMTP应用密码                    │
│  ✓ 启用双重验证                        │
│  ✓ 生成应用密码                        │
└────────────────────────────────────────┘
    ↓
┌────────────────────────────────────────┐
│  第3步: 配置.env文件                    │
│  ✓ 填写所有凭据                        │
│  ✓ 设置邮件筛选条件                    │
└────────────────────────────────────────┘
    ↓
┌────────────────────────────────────────┐
│  第4步: 安装依赖                        │
│  ✓ pip install workflow-tools         │
│  ✓ pip install -r requirements.txt    │
└────────────────────────────────────────┘
    ↓
┌────────────────────────────────────────┐
│  第5步: 测试验证                        │
│  ✓ 测试邮件读取                        │
│  ✓ 测试邮件发送                        │
└────────────────────────────────────────┘
    ↓
配置完成 ✅
```

---

## 详细配置流程

### 📋 第1步: Azure应用注册

```
访问Azure Portal
    ↓
搜索"应用注册"
    ↓
点击"新注册"
    ↓
填写应用信息 ─────┐
    ↓            │
应用创建成功       │
    ↓            │
┌───────────────┐ │
│ 记录Client ID  │ │
└───────────────┘ │
    ↓            │
┌───────────────┐ │
│ 记录Tenant ID  │ │
└───────────────┘ │
    ↓            │
创建客户端密钥      │
    ↓            │
┌─────────────────┐│
│ 记录Client Secret││
└─────────────────┘│
    ↓             │
配置API权限 ────────┤
    ↓             │
添加Mail.Read权限   │
    ↓             │
授予管理员同意 ✅   │
    ↓             │
Azure配置完成 ←────┘
```

**需要记录的信息:**

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ OUTLOOK_CLIENT_ID               ┃
┃ → 应用程序(客户端) ID             ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ OUTLOOK_TENANT_ID               ┃
┃ → 目录(租户) ID                  ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃ OUTLOOK_CLIENT_SECRET           ┃
┃ → 客户端密钥值                   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

---

### 🔒 第2步: SMTP应用密码

```
访问Microsoft账户安全
    ↓
检查双重验证状态
    ↓
    ├─ 已启用 ─────────┐
    │                 │
    └─ 未启用         │
        ↓            │
    启用双重验证      │
        ↓            │
    按提示验证手机    │
        ↓            │
    双重验证开启 ─────┘
              ↓
        找到"应用密码"
              ↓
        创建新应用密码
              ↓
        ┌─────────────────┐
        │ 记录16位密码      │
        └─────────────────┘
              ↓
        SMTP配置完成 ✅
```

**需要记录的信息:**

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ OUTLOOK_SMTP_PASSWORD           ┃
┃ → 16位应用专用密码               ┃
┃   (格式: xxxx xxxx xxxx xxxx)   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

---

### ⚙️ 第3步: 配置环境变量

```
复制env.example
    ↓
创建.env文件
    ↓
填写配置项
    ↓
┌─────────────────────────────────┐
│ OUTLOOK_EMAIL                   │
│ OUTLOOK_CLIENT_ID               │
│ OUTLOOK_CLIENT_SECRET           │
│ OUTLOOK_TENANT_ID               │
│ OUTLOOK_SMTP_PASSWORD           │
│ EMAIL_FILTER_SENDER             │
│ GEMINI_API_KEY                  │
│ SUMMARY_RECIPIENT               │
└─────────────────────────────────┘
    ↓
保存.env文件
    ↓
配置文件准备完成 ✅
```

---

### 📦 第4步: 安装依赖

```
打开终端
    ↓
cd workflow-tools
    ↓
pip install -e .[all]
    ↓
workflow-tools安装完成
    ↓
cd ..
    ↓
pip install -r requirements.txt
    ↓
主程序依赖安装完成 ✅
```

---

### ✅ 第5步: 测试验证

```
运行测试脚本
    ↓
    ├─ test_outlook_read.py
    │       ↓
    │   加载环境变量
    │       ↓
    │   创建客户端
    │       ↓
    │   连接Graph API
    │       ↓
    │   获取邮件列表
    │       ↓
    │   ✓ 读取测试通过
    │
    └─ test_outlook_send.py
            ↓
        加载环境变量
            ↓
        创建客户端
            ↓
        发送测试邮件
            ↓
        ✓ 发送测试通过
            ↓
        ✅ 所有测试通过
```

---

## 权限关系图

### Microsoft Graph API权限

```
Azure应用
    ↓
    ├─ 应用程序权限 (Application Permissions)
    │   ├─ Mail.Read ✅ (必需)
    │   │   → 读取所有邮箱的邮件
    │   │
    │   └─ Mail.ReadWrite (可选)
    │       → 读写邮件,标记已读
    │
    └─ 管理员同意 ✅ (必需)
        → 激活权限
```

### SMTP认证链

```
Microsoft账户
    ↓
    ├─ 双重验证 ✅ (前提条件)
    │   └─ 手机验证
    │
    └─ 应用密码 ✅
        ├─ 16位密码
        └─ 用于SMTP认证
            ↓
        SMTP服务器
            ├─ smtp-mail.outlook.com
            ├─ 端口: 587
            └─ STARTTLS加密
```

---

## 配置检查清单

```
┌─────────────────────────────────────┐
│ □ Azure应用已注册                    │
│ □ Client ID已记录                   │
│ □ Client Secret已记录               │
│ □ Tenant ID已记录                   │
│ □ API权限Mail.Read已添加             │
│ □ 管理员同意已授予                   │
├─────────────────────────────────────┤
│ □ 双重验证已启用                     │
│ □ SMTP应用密码已生成                │
├─────────────────────────────────────┤
│ □ .env文件已创建                    │
│ □ 所有环境变量已填写                 │
├─────────────────────────────────────┤
│ □ workflow-tools已安装              │
│ □ 主程序依赖已安装                   │
├─────────────────────────────────────┤
│ □ 邮件读取测试通过                   │
│ □ 邮件发送测试通过                   │
└─────────────────────────────────────┘

所有项目都勾选 ✅ → 配置完成!
```

---

## 系统架构图

```
┌──────────────────────────────────────────────────────┐
│                   主程序 (main.py)                     │
└─────────────┬────────────────────────┬───────────────┘
              │                        │
     ┌────────▼────────┐      ┌───────▼────────┐
     │  OutlookClient  │      │  GeminiClient  │
     │  (邮件处理)      │      │  (AI分析)       │
     └────────┬────────┘      └───────┬────────┘
              │                        │
     ┌────────▼────────────────────────▼────────┐
     │         Workflow Tools Library            │
     │  ┌──────────┐  ┌──────────┐  ┌─────────┐│
     │  │  Email   │  │   AI     │  │Scheduler││
     │  │  Module  │  │  Module  │  │ Module  ││
     │  └──────────┘  └──────────┘  └─────────┘│
     └──────────────────────────────────────────┘
              │                        │
     ┌────────▼────────┐      ┌───────▼────────┐
     │ Microsoft Graph │      │  Gemini API    │
     │      API        │      │                │
     │   (读取邮件)     │      │  (AI分析)       │
     └─────────────────┘      └────────────────┘
              │
     ┌────────▼────────┐
     │  SMTP Server    │
     │  (发送邮件)      │
     └─────────────────┘
```

---

## 数据流图

### 邮件读取流程

```
[Outlook邮箱]
    ↓
    │ OAuth 2.0认证
    ↓
[Microsoft Graph API]
    ↓
    │ HTTPS请求
    ↓
[OutlookClient]
    ↓
    │ 解析JSON
    ↓
[EmailMessage对象]
    ↓
[主程序处理]
```

### 邮件发送流程

```
[主程序]
    ↓
    │ 邮件内容
    ↓
[OutlookClient]
    ↓
    │ SMTP认证
    ↓
[SMTP Server]
    ↓
    │ 发送
    ↓
[收件人邮箱]
```

### 完整工作流

```
[定时器触发]
    ↓
[读取邮件] ─→ [筛选条件]
    ↓           ├─ 主题: "每日总结"
[邮件列表]      ├─ 发件人: 指定邮箱
    ↓           └─ 时间: 最近24小时
[合并内容]
    ↓
[AI分析] ─→ [Gemini API]
    ↓
[生成总结]
    ↓
[发送邮件] ─→ [收件人]
    ↓
[保存历史记录]
    ↓
[任务完成] ✅
```

---

## 故障排除流程图

```
遇到问题
    ↓
    ├─ 认证失败?
    │   ↓
    │   ├─ Azure凭据错误 → 重新检查Client ID/Secret
    │   ├─ 权限未授予 → 授予管理员同意
    │   └─ 密钥过期 → 重新生成密钥
    │
    ├─ 连接失败?
    │   ↓
    │   ├─ 网络问题 → 检查防火墙
    │   └─ 服务器错误 → 查看日志
    │
    ├─ 找不到邮件?
    │   ↓
    │   ├─ 过滤条件太严 → 调整筛选条件
    │   ├─ 时间范围问题 → 扩大时间范围
    │   └─ 邮箱为空 → 发送测试邮件
    │
    └─ 发送失败?
        ↓
        ├─ SMTP认证失败 → 检查应用密码
        ├─ 收件人错误 → 验证邮箱地址
        └─ 网络问题 → 检查SMTP端口
```

---

## 时间线

```
配置前准备 (0分钟)
    │
    ├─ 准备Microsoft账号
    ├─ 准备手机(用于双重验证)
    └─ 打开必需的网站
    ↓
Azure配置 (5分钟)
    │
    ├─ 应用注册 (2分钟)
    ├─ 创建密钥 (1分钟)
    └─ 配置权限 (2分钟)
    ↓
SMTP配置 (3分钟)
    │
    ├─ 启用双重验证 (2分钟)
    └─ 生成应用密码 (1分钟)
    ↓
环境配置 (2分钟)
    │
    ├─ 复制.env文件 (10秒)
    └─ 填写所有变量 (1分50秒)
    ↓
安装依赖 (3分钟)
    │
    ├─ 安装workflow-tools (2分钟)
    └─ 安装主程序依赖 (1分钟)
    ↓
测试验证 (2分钟)
    │
    ├─ 测试邮件读取 (1分钟)
    └─ 测试邮件发送 (1分钟)
    ↓
总计: 约15分钟 ✅
```

---

## 配置成功标志

```
✅ 所有测试脚本运行成功
✅ 能够读取邮件列表
✅ 能够发送测试邮件
✅ 日志没有错误信息
✅ 历史记录正常保存

🎉 配置完成,系统可以正常运行!
```

