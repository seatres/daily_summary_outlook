# 每日总结邮件自动化 - 使用说明

## 🎯 功能概述

这是一个自动化工具，可以：
1. 📧 从邮箱读取"每日总结"邮件
2. 🤖 使用 Gemini AI 进行深度分析
3. ✉️ 将分析结果发送到指定邮箱

## 📋 两种运行方式

### 方式 1: 立即执行（推荐）

**特点**：
- ✅ 执行一次后自动退出
- ✅ 读取过去24小时的邮件
- ✅ 适合配合 launchd 定时执行
- ✅ 不占用系统资源

**使用方法**：
```bash
python main.py --once
```

### 方式 2: 持续运行

**特点**：
- ✅ 程序持续运行
- ✅ 每晚22:00自动执行
- ⚠️ 需要保持终端或使用后台运行

**使用方法**：
```bash
python main.py
```

## 🚀 快速开始

### 1. 配置环境变量

编辑 `.env` 文件：
```bash
# 邮件客户端类型
EMAIL_CLIENT_TYPE=qq

# QQ邮箱配置
EMAIL_ADDRESS=你的QQ邮箱@qq.com
EMAIL_PASSWORD=QQ邮箱授权码

# 邮件筛选
EMAIL_FILTER_SENDER=发件人邮箱

# Gemini AI
GEMINI_API_KEY=你的Gemini密钥

# 总结接收邮箱
SUMMARY_RECIPIENT=接收总结的邮箱

# SMTP配置
SMTP_USE_SSL=true
```

### 2. 测试运行

```bash
# 立即执行一次测试
python main.py --once
```

### 3. 设置定时任务

**选项 A: 使用安装脚本（推荐）**
```bash
./install_launchd.sh
```

**选项 B: 手动安装**
```bash
# 复制 plist 文件
cp com.user.dailysummary.plist ~/Library/LaunchAgents/

# 加载服务
launchctl load ~/Library/LaunchAgents/com.user.dailysummary.plist
```

## ⏰ 定时任务说明

- **执行时间**: 每天晚上 22:00
- **执行内容**: 读取过去24小时的"每日总结"邮件并分析
- **运行方式**: `python main.py --once`（执行完自动退出）
- **系统要求**: macOS 保持开机（可以合盖，不能关机）

## 📊 查看日志

### 程序日志
```bash
# 查看今天的日志
tail -f logs/workflow_$(date +%Y%m%d).log

# 查看所有日志文件
ls -lh logs/
```

### launchd 日志
```bash
# 标准输出
tail -f logs/launchd_out.log

# 错误输出
tail -f logs/launchd_err.log
```

## 🛠️ 管理定时任务

### 查看服务状态
```bash
launchctl list | grep dailysummary
```

### 手动触发一次
```bash
launchctl start com.user.dailysummary
```

### 停止服务
```bash
launchctl unload ~/Library/LaunchAgents/com.user.dailysummary.plist
```

### 重新加载服务（修改配置后）
```bash
launchctl unload ~/Library/LaunchAgents/com.user.dailysummary.plist
launchctl load ~/Library/LaunchAgents/com.user.dailysummary.plist
```

### 删除服务
```bash
launchctl unload ~/Library/LaunchAgents/com.user.dailysummary.plist
rm ~/Library/LaunchAgents/com.user.dailysummary.plist
```

## 📁 文件说明

| 文件/目录 | 说明 |
|----------|------|
| `main.py` | 主程序 |
| `.env` | 环境变量配置 |
| `config.py` | 程序配置 |
| `com.user.dailysummary.plist` | launchd 配置文件 |
| `install_launchd.sh` | 自动安装脚本 |
| `logs/` | 日志目录 |
| `history/` | 历史记录目录 |
| `LAUNCHD_SETUP.md` | 详细设置指南 |

## 🔧 修改执行时间

编辑 `~/Library/LaunchAgents/com.user.dailysummary.plist`：

```xml
<key>StartCalendarInterval</key>
<dict>
    <key>Hour</key>
    <integer>22</integer>  <!-- 小时 (0-23) -->
    <key>Minute</key>
    <integer>0</integer>   <!-- 分钟 (0-59) -->
</dict>
```

然后重新加载服务。

## ⚠️ 注意事项

1. **电脑需要开机**: launchd 只在电脑开机时运行（可以合盖睡眠，但不能关机）

2. **Python 路径**: 确保 plist 中的 Python 路径正确
   ```bash
   which python  # 查看当前 Python 路径
   ```

3. **环境变量**: `.env` 文件必须在项目根目录

4. **邮件筛选**:
   - 主题必须包含 `EMAIL_FILTER_SUBJECT` 的值（默认"每日总结"）
   - 发件人必须是 `EMAIL_FILTER_SENDER` 的值

5. **时区**: 执行时间基于系统时区

## 🧪 测试流程

1. **测试立即执行**:
   ```bash
   python main.py --once
   ```

2. **检查日志**:
   ```bash
   tail -20 logs/workflow_$(date +%Y%m%d).log
   ```

3. **检查邮箱**: 确认收到AI分析邮件

4. **测试 launchd**:
   ```bash
   # 手动触发
   launchctl start com.user.dailysummary

   # 查看日志
   tail -20 logs/launchd_out.log
   ```

## 📞 故障排查

### 问题1: 服务未执行
```bash
# 检查服务状态
launchctl list | grep dailysummary

# 查看错误日志
tail -50 logs/launchd_err.log

# 手动测试
python main.py --once
```

### 问题2: 找不到邮件
- 检查 `.env` 中的 `EMAIL_FILTER_SENDER` 和 `EMAIL_FILTER_SUBJECT`
- 确认邮件确实存在且时间在24小时内
- 查看日志了解详细情况

### 问题3: AI 分析失败
- 检查 `GEMINI_API_KEY` 是否正确
- 确认网络连接正常
- 检查 Gemini API 配额

## 📚 更多文档

- 详细设置指南: `LAUNCHD_SETUP.md`
- QQ邮箱配置: `QQ邮箱配置指南.md`
- 项目说明: `README.md`
